@{
    ViewData["Title"] = "Map";
}

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="searchBar">
    <h2>Map</h2>
    <div class="searchWrap">
        <input id="searchInput" type="search" placeholder="Search for station..." />
        <ul id="searchResults"></ul>
    </div>
    
</div>
<div id="mapWrap" style="position:relative;">
    <div id="map" style="height: 80vh; width: 100%; border: 1px solid #ccc;"></div>

    <!-- Simple station info "card" overlay -->
    <div id="stationCard">

    </div>
</div>



<script>
    const londonBounds = L.latLngBounds([51.20, -0.65], [51.80, 0.45]);
    const card = document.getElementById("stationCard");
    document.getElementById("searchInput").addEventListener("input", (e) => {
        searchStations(e.target.value);
    });
    // London-ish default
        const map = L.map('map', {
      minZoom: 11,
      maxZoom: 14,
      maxBounds: londonBounds,
      maxBoundsViscosity: 0.5,
      zoomControl: false
    }).fitBounds(londonBounds);

    function crowdLabel(pct){
        if(pct == null) return "Unknown";
        if(pct < 10) return "Very Quiet";
        if(pct < 40) return "Quiet";
        if(pct < 80) return "Busy";
        return "Very Busy";
    }

    function crowdColor(pct){
        if(pct == null) return "#9e9e9e";
        if(pct < 10) return "#FFFFFF";
        if(pct < 40) return "#FFA500";
        if(pct < 80) return "#FF2400";
        return "#f44336";

    }

    function renderCrowdingCard({name, pct, timeLocal, available}){
        pct = pct * 100;
        const safePct = pct == null ? 0 : Math.min(100, Math.max(0, pct));
        const barColor = 
        pct == null ? "#ccc":
        pct < 10 ? "#D3D3D3":
        pct < 40 ? "#FFA500":
        pct < 80 ? "#FF2400": "#f44336";
        const label = crowdLabel(pct);
          return `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-size:18px; font-weight:700;">${name}</div>
        </div>
        <button id="closeCardBtn" style="border:none; background:transparent; font-size:18px; cursor:pointer;">✕</button>
      </div>

      <div style="margin-top:12px; padding:12px; border:1px solid #eee; border-radius:12px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="font-size:16px; font-weight:700;">${label}</div>
        </div>
           <div style="margin-top:10px; height:10px; background:#f1f1f1; border-radius:999px; overflow:hidden;">
          <div style="
            height:100%;
            width:${safePct}%;
            background:${barColor};
          "></div>
        </div>

        <div style="margin-top:10px; font-size:12px; color:#555; display:grid; gap:4px;">
          <div><b>Updated:</b> ${timeLocal ?? ""}</div>
        </div>
      </div>
    `;
    }
    function showCard(html){
        card.style.display = "block";
        card.innerHTML = html;
    }
    function hideCard(){
        card.style.display = "none";
        card.innerHTML = "";
    }

    async function searchStations(query){
        const resultsEl = document.getElementById("searchResults");
        query = query.trim();
        if(query.length < 2){
            resultsEl.innerHTML = "";
            return;

        }
        const res = await fetch(`/api/train/crowding/search?query=${encodeURIComponent(query)}`);
        if(!res.ok){
            console.error("Search failed");
            return;
        }

        const stations = await res.json();
        resultsEl.innerHTML = "";

        stations.slice(0,8).forEach(s => {
            const li = document.createElement("li");
            li.textContent = s.name;
            li.onclick = () =>{
                onStationClick(s);
                
                resultsEl.innerHTML = "";
            };
            resultsEl.appendChild(li);
            
        });
    }
    async function onStationClick(station){
        map.setView([station.lat, station.lon], 14, {animate:true});

        const request = await fetch(`/api/train/crowding/live?naptan=${station.naptan}`);
        const live = await request.json();
        const pct = live.percentageOfBaseline;
        const safePct = (pct == null) ? null : pct * 100;
        const available = live.dataAvailable;
        const timeLocal = live.timeLocal;
        const name = station.name ?? station.Name;
        const marker = markersByNaptan.get(station.naptan);
        if(marker){
            marker.setStyle({fillColor: crowdColor(safePct)});
        }
        showCard(renderCrowdingCard({
          name,
          pct,
          timeLocal,
          available
        })
     );

      document.getElementById("closeCardBtn").onclick = (e) => {
      e.stopPropagation();   // prevents map click closing immediately
      hideCard();
    };
    }
    

    // OpenStreetMap tiles (no key)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markersByNaptan = new Map();
    (async function loadStations(){
        const response = await fetch (`/api/train/crowding/tube-stations`);
        const data = await response.json();
        data.forEach(station => {
            if(station.lat && station.lon){
                

                const naptan = station.naptan;

                const marker = L.circleMarker([station.lat, station.lon], {
                    radius: 6,
                    weight: 1,
                    fillColor: "#2ecc71",
                    fillOpacity: 0.9,
                    color: "#2c3e50"
                });
                markersByNaptan.set(naptan,marker);
                marker.addTo(map).bindTooltip(station.name, {direction: 'top', opacity: 0.9});

                marker.on('click', (e) => {
                    e.originalEvent?.stopPropagation(); // stop map click from firing
                    onStationClick(station);
                  });
                
                
            }
        });
    })();
</script>